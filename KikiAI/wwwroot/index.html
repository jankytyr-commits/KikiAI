<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KikiAI Chat</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="menuBar">
        <button class="menuBtn" onclick="repeatLast()">üîÑ Zopakovat p≈ôedchoz√≠</button>
        <button class="menuBtn" onclick="startNewChat()">‚ûï Nov√Ω chat</button>
        <button class="menuBtn" onclick="exportChat()">üíæ Exportovat chat</button>
    </div>
    <div id="modelSelector">
        <button class="modelBtn active" data-provider="gemini" onclick="selectModel('gemini')">
            <div class="modelName">Gemini 2.0 Flash</div>
            <div class="modelStats"><span class="tokenUsage">0</span> / 1,000,000</div>
        </button>
        <button class="modelBtn" data-provider="gemini-2.5" onclick="selectModel('gemini-2.5')">
            <div class="modelName">Gemini 2.5 Flash</div>
            <div class="modelStats"><span class="tokenUsage">0</span> / 1,000,000</div>
        </button>
        <button class="modelBtn disabled" data-provider="openai" disabled>
            <div class="modelName">OpenAI GPT-4o</div>
            <div class="modelStats">Quota Exceeded</div>
        </button>
        <button class="modelBtn" data-provider="openai-test" onclick="selectModel('openai-test')">
            <div class="modelName">GPT-4o-mini</div>
            <div class="modelStats"><span class="tokenUsage">0</span> / 128,000</div>
        </button>
        <button class="modelBtn disabled" data-provider="claude" disabled>
            <div class="modelName">Claude 3.5 Sonnet</div>
            <div class="modelStats">Pro Only</div>
        </button>
        <button class="modelBtn" data-provider="claude-haiku" onclick="selectModel('claude-haiku')">
            <div class="modelName">Claude 3.5 Haiku</div>
            <div class="modelStats"><span class="tokenUsage">$0.00</span> / $5.00</div>
        </button>
        <button class="modelBtn" data-provider="mistral" onclick="selectModel('mistral')">
            <div class="modelName">Mistral Small</div>
            <div class="modelStats"><span class="tokenUsage">0</span> / 32,000</div>
        </button>
        <button class="modelBtn" data-provider="mistral-large" onclick="selectModel('mistral-large')">
            <div class="modelName">Mistral Large</div>
            <div class="modelStats"><span class="tokenUsage">0</span> / 128,000</div>
        </button>
    </div>
    <div id="mainContent">
        <div id="chatArea">
            <div id="chat"></div>
            <div id="inputArea">
                <textarea id="input" rows="3" placeholder="Zadejte zpr√°vu... (Ctrl+Enter pro odesl√°n√≠)"></textarea>
                <button id="send">Odeslat</button>
            </div>
        </div>
        <div id="sidebar">
            <h3>Chats</h3>
            <ul id="sessions"></ul>
            <h3>Notifications</h3>
            <div id="notifications"></div>
        </div>
    </div>
    <script>
        const chatDiv = document.getElementById('chat');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const notificationsDiv = document.getElementById('notifications');
        let conversationHistory = [];
        let currentProvider = 'gemini';
        let totalTokens = 0;
        let claudeUsage = { totalCost: 0, isWithinLimit: true };
        let lastUserMessage = '';
        let currentSessionId = null;
        const tokenLimits = {
            'gemini': 1000000,
            'gemini-2.5': 1000000,
            'openai': 128000,
            'openai-test': 128000,
            'claude': 200000,
            'claude-haiku': 200000,
            'mistral': 32000,
            'mistral-large': 128000
        };

        async function loadHistory() {
            try {
                const r = await fetch('/api/chat/history');
                if (r.ok) {
                    const session = await r.json();
                    if (session) {
                        currentSessionId = session.id;
                        conversationHistory = session.messages || [];
                        chatDiv.innerHTML = '';
                        totalTokens = 0;
                        conversationHistory.forEach(msg => {
                            const tokens = estimateTokens(msg.content);
                            totalTokens += tokens;
                            addMessage(msg.content, msg.role === 'assistant' ? 'bot' : 'user', tokens);
                        });
                        updateAllTokenDisplays();
                        chatDiv.scrollTop = chatDiv.scrollHeight;
                        addNotification('Info', 'Historie naƒçtena.');
                    }
                }
            } catch (e) {
                console.error(e);
                addNotification('Error', 'Nepoda≈ôilo se naƒç√≠st historii.');
            }
        }

        async function startNewChat() {
            if (confirm('Zah√°jit nov√Ω chat?')) {
                try {
                    const r = await fetch('/api/chat/new', { method: 'POST' });
                    if (r.ok) {
                        const session = await r.json();
                        currentSessionId = session.id;
                        conversationHistory = [];
                        chatDiv.innerHTML = '';
                        totalTokens = 0;
                        lastUserMessage = '';
                        updateAllTokenDisplays();
                        addNotification('Info', 'Nov√Ω chat zah√°jen.');
                        loadSessions();
                    }
                } catch (e) {
                    addNotification('Error', 'Chyba p≈ôi vytv√°≈ôen√≠ chatu.');
                }
            }
        }

        async function loadClaudeUsage() {
            try {
                const r = await fetch('/api/chat/claude-usage');
                if (r.ok) {
                    claudeUsage = await r.json();
                    updateClaudeDisplay();
                }
            } catch (e) { }
        }

        function updateClaudeDisplay() {
            ['claude-haiku'].forEach(p => {
                const btn = document.querySelector(`[data-provider="${p}"]`);
                if (btn && !btn.classList.contains('disabled')) {
                    const s = btn.querySelector('.modelStats');
                    if (s) s.innerHTML = `<span class="tokenUsage">$${claudeUsage.totalCost.toFixed(2)}</span> / $5.00`;
                    if (!claudeUsage.isWithinLimit) disableProvider(p, 'Monthly Limit Reached');
                }
            });
        }

        function estimateTokens(text) { return Math.ceil(text.length / 4); }

        function updateAllTokenDisplays() {
            document.querySelectorAll('.modelBtn').forEach(btn => {
                if (!btn.classList.contains('disabled')) {
                    const p = btn.dataset.provider;
                    if (p === 'claude-haiku') return;
                    const u = btn.querySelector('.tokenUsage');
                    if (u) u.textContent = totalTokens.toLocaleString();
                    const limit = tokenLimits[p];
                    if (limit && totalTokens > limit) disableProvider(p, 'Token Limit Exceeded');
                }
            });
        }

        function selectModel(p) {
            const btn = document.querySelector(`[data-provider="${p}"]`);
            if (!btn || btn.classList.contains('disabled')) return;
            document.querySelectorAll('.modelBtn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentProvider = p;
            addNotification('Info', `P≈ôepnuto na: ${btn.querySelector('.modelName').textContent}`);
        }

        function exportChat() {
            const text = conversationHistory.map(m => `[${m.role.toUpperCase()}]: ${m.content}`).join('\n\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addNotification('Success', 'Chat exportov√°n.');
        }

        function repeatLast() {
            if (lastUserMessage) {
                input.value = lastUserMessage;
                input.focus();
                addNotification('Info', 'P≈ôedchoz√≠ dotaz zkop√≠rov√°n.');
            } else {
                addNotification('Warn', '≈Ω√°dn√Ω p≈ôedchoz√≠ dotaz.');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                addNotification('Success', 'Zkop√≠rov√°no do schr√°nky!');
            }).catch(() => {
                addNotification('Error', 'Nelze zkop√≠rovat');
            });
        }

        function parseMarkdown(text) {
            const placeholders = [];
            const addPlaceholder = (content, type) => {
                placeholders.push({ content, type });
                return `%%%LINKPH${placeholders.length - 1}%%%`;
            };
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (m, title, url) => addPlaceholder({ title, url }, 'mdlink'));
            text = text.replace(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g, m => addPlaceholder(m, 'email'));
            text = text.replace(/(https?:\/\/[^\s<>"]+)/g, m => addPlaceholder(m, 'url'));
            text = text.replace(/(^|[\s(])(www\.[^\s<>"]+)/g, (m, prefix, u) => prefix + addPlaceholder(u, 'www'));
            let html = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            html = html.replace(/```([\s\S]*?)```/g, '<pre><button class="copyBtn" onclick="copyToClipboard(this.nextElementSibling.textContent)">Kop√≠rovat</button><code>$1</code></pre>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(\<li\>.*\<\/li\>)/s, '<ul>$1</ul>');
            html = html.replace(/%%%LINKPH(\d+)%%%/g, (m, i) => {
                const item = placeholders[parseInt(i)];
                if (!item) return m;
                if (item.type === 'mdlink') return `<a href="${item.content.url}" target="_blank">${item.content.title}</a> <button class="copyBtn" onclick="copyToClipboard('${item.content.url}')">üìã</button>`;
                if (item.type === 'email') return `<a href="mailto:${item.content}">${item.content}</a> <button class="copyBtn" onclick="copyToClipboard('${item.content}')">üìã</button>`;
                if (item.type === 'url' || item.type === 'www') {
                    const href = item.type === 'www' ? 'http://' + item.content : item.content;
                    return `<a href="${href}" target="_blank">${item.content}</a> <button class="copyBtn" onclick="copyToClipboard('${href}')">üìã</button>`;
                }
                return m;
            });
            return html;
        }

        function addMessage(text, role, tokens = 0) {
            const el = document.createElement('div');
            el.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
            const header = document.createElement('div');
            header.className = 'msgHeader';
            header.textContent = role === 'user' ? 'üßë‚Äçüíª U≈æivatel' : 'ü§ñ AI';
            if (tokens > 0) header.textContent += ` ‚Ä¢ ${tokens.toLocaleString()} token≈Ø`;
            const content = document.createElement('div');
            content.className = 'msgContent';
            content.innerHTML = parseMarkdown(text);
            el.appendChild(header);
            el.appendChild(content);
            chatDiv.appendChild(el);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function addNotification(type, msg) {
            const el = document.createElement('div');
            el.className = 'note ' + type.toLowerCase();
            const time = new Date().toLocaleTimeString();
            el.innerHTML = `<strong>${type}</strong> <span style="font-size:0.8em;opacity:0.7">(${time})</span><br />${msg}`;
            notificationsDiv.insertBefore(el, notificationsDiv.firstChild);
        }

        async function sendMessage() {
            const userInput = input.value.trim();
            if (!userInput) return;
            lastUserMessage = userInput;
            const userTokens = estimateTokens(userInput);
            addMessage(userInput, 'user', userTokens);
            input.value = '';
            conversationHistory.push({ role: 'user', content: userInput });
            totalTokens += userTokens;
            updateAllTokenDisplays();
            addNotification('Info', `Odes√≠l√°m... (${userTokens} token≈Ø)`);
            try {
                const resp = await fetch('/api/chat/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        provider: currentProvider,
                        sessionId: currentSessionId
                    })
                });
                const data = await resp.json();
                if (data.success) {
                    if (data.sessionId) currentSessionId = data.sessionId;
                    let botMsg = data.response;
                    if (botMsg.startsWith('[[FALLBACK_WARNING]]')) {
                        botMsg = botMsg.replace('[[FALLBACK_WARNING]]', '');
                        addNotification('Warn', 'Model vyƒçerp√°n. Pou≈æit fallback.');
                        disableProvider(currentProvider, 'Quota Exceeded');
                    }
                    const botTokens = estimateTokens(botMsg);
                    addMessage(botMsg, 'bot', botTokens);
                    conversationHistory.push({ role: 'assistant', content: botMsg });
                    totalTokens += botTokens;
                    updateAllTokenDisplays();
                    if (currentProvider === 'claude-haiku') await loadClaudeUsage();
                    addNotification('Success', `Odpovƒõƒè p≈ôijata. Celkem: ${totalTokens.toLocaleString()} token≈Ø.`);
                    loadSessions(); // Refresh sessions list after message
                } else {
                    addNotification('Error', data.error);
                    if (/(429|TooManyRequests|Quota|403)/.test(data.error))
                        disableProvider(currentProvider, 'Quota Exceeded');
                }
            } catch (e) {
                addNotification('Error', 'Network Error: ' + e.message);
            }
        }

        function disableProvider(p, reason = 'Unavailable') {
            const btn = document.querySelector(`[data-provider="${p}"]`);
            if (btn && !btn.classList.contains('disabled')) {
                btn.classList.add('disabled');
                btn.disabled = true;
                btn.querySelector('.modelStats').innerHTML = `<span style="color:#ff6b6b;">${reason}</span>`;
                addNotification('Warn', `Provider '${p}' deaktivov√°n: ${reason}`);
                const next = Array.from(document.querySelectorAll('.modelBtn:not(.disabled)')).find(b => !b.disabled);
                if (next) selectModel(next.dataset.provider);
            }
        }

        sendBtn.addEventListener('click', sendMessage);

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.ctrlKey) {
                e.preventDefault();
                sendMessage();
            } else if (e.key === 'Enter' && e.ctrlKey) {
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const value = input.value;
                input.value = value.slice(0, start) + '\n' + value.slice(end);
                input.selectionStart = input.selectionEnd = start + 1;
                e.preventDefault();
            }
        });

        loadClaudeUsage();
        loadHistory();
        loadSessions();

        async function loadSessions() {
            try {
                const r = await fetch('/api/chat/sessions');
                if (r.ok) {
                    const list = await r.json();
                    const ul = document.getElementById('sessions');
                    ul.innerHTML = '';
                    list.forEach(s => {
                        const li = document.createElement('li');
                        li.textContent = new Date(s.createdAt).toLocaleString();
                        li.title = s.id;
                        if (s.id === currentSessionId) li.classList.add('active');
                        li.onclick = () => loadSession(s.id);
                        ul.appendChild(li);
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function loadSession(id) {
            try {
                const r = await fetch(`/api/chat/session/${id}`);
                if (r.ok) {
                    const session = await r.json();
                    currentSessionId = session.id;
                    conversationHistory = session.messages || [];
                    chatDiv.innerHTML = '';
                    totalTokens = 0;
                    conversationHistory.forEach(msg => {
                        const tokens = estimateTokens(msg.content);
                        totalTokens += tokens;
                        addMessage(msg.content, msg.role === 'assistant' ? 'bot' : 'user', tokens);
                    });
                    updateAllTokenDisplays();
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                    addNotification('Info', 'Chat naƒçten.');
                    loadSessions();
                }
            } catch (e) { console.error(e); }
        }
    </script>
</body>

</html>